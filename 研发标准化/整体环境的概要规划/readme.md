# 环境一览图

```plantuml
@startuml
!include  https://plantuml.s3.cn-north-1.jdcloud-oss.com/C4_Container.puml

Boundary(开发测试网络, 开发测试网络, vlan-1) {
    System(开发环境, 开发环境)
    System(测试环境, 测试环境)
    System(数据存储, 数据存储)
    
    开发环境 -d-> 数据存储
    测试环境 -d-> 数据存储
}

Boundary(预生产网络, 预生产网络, vlan-2) {
    System(预发环境, 预发环境)
}

Boundary(生产网络, 生产网络, vlan-3) {
    System(生产环境, 生产环境)
}

Boundary(生产设备网络, 生产设备网络, vlan-4) {
    System(生产数据存储, 生产数据存储)
}

预发环境 -d-> 生产数据存储
生产环境 -d-> 生产数据存储
@enduml
```

## 开发测试环境的说明

* 较为经典的网络划分是开发和测试环境为一个2层网络(vlan-1)，生产网络是另一个2层网络(vlan-2)
  ，同时预发也是1个2层网络，2层网络的隔离显著降低彼此之间进行干扰的可能
* 开发测试所需的底层存储和预发生产所需的底层存储是完全隔离的，降低彼此的干扰
* 预发和生产所需的存储<font color=red>尽可能</font>分开，但是考虑到建设成本，通常会采用混用的情况
* 预生产网络和生产网络通过路由策略和生产存储网络进行打通，除此之外网络与网络之间不具有3层可达的路由策略
* <font color=red>网络可不达有效避免了因为配置的错误配置或者人员的不小心操作造成的意外，
  比如预生产不小心修改了生产的数据库的ddl</font>
* 开发测试环境使用的机器倾向于利旧而不是新采，其底层通过K8S统一管理和调度，通过名称空间的不同来区分是开发还是测试
* 混合部署的理由是开发很少能将资源用满，而且大部分代码在开发时运行在开发者的pc上，而不是环境内，开发环境更多的是开通的中间件
* 在此约定，"-dev"结尾的名称空间是开发，"-test"结尾的名称空间是测试
* 任何名称空间都必须被分配配额，这意味着任何发布的应用都必须声明自己使用的资源
* 开发和测试资源使用的远程存储为一个独立的分布式数据存储，未来有必要时继续将利旧的机器在这个存储中扩容，
  <font color=red>该环境承载功能测试但不承载压力测试</font>

## 预发和生产环境的说明

```plantuml
@startuml
!include  https://plantuml.s3.cn-north-1.jdcloud-oss.com/C4_Container.puml

Person(测试, 测试)
Person(用户, 用户)

Boundary(预生产网络, 预生产网络, vlan-2) {
    System(预发环境, 预发环境)
    System(预发数据库, 预发数据库)
}

Boundary(生产网络, 生产网络, vlan-3) {
    System(生产环境, 生产环境)
    System(生产数据库, 生产数据库)
}

生产数据库 -r-> 预发数据库: 定期离线同步

预发环境 --> 预发数据库
生产环境 --> 生产数据库

测试 --> 预发环境
用户 --> 生产环境

@enduml
```

* 预发环境的目标是执行生产前的最终验证，包括数据库的变更、压力测试等，因此资源基本和生产环境1:1建设或最低1:0.5建设
* 预发环境所需的数据是从生产环境的定期备份导出形成的，预发过程中不能直接修改生产环境的数据库和产生测试数据
* 系统的投产上线先在预发环境上执行，如有问题则修改问题后重新执行比如变更数据ddl

# 预发环境的必要性

建设预发环境是对生产环境的一种保护，否则任何变更都直接对生产环境执行如果出现问题则可能造成不可逆的结果。
同时系统上线前一般会进行压力测试，预发环境还可以承载一定程度的压测环境使用，否则就只能在线上直接压力测试。
诚然，预发环境的建设具有成本，且大部分时间都没有在有效的使用，但对比直接操作线上可能引发的故障，该环境还是有必要建设的。


