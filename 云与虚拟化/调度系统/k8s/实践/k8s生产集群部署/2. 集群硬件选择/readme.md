# 宗旨

本文在于指导容器云集群的硬件规划和使用，主要将涉及不同用途的服务器选择以及网络设备和存储集群的选择。

# 总则

若无特殊说明，以下内容适用于所有服务器

* 基本以x86作为主要的cpu架构
* 操作系统磁盘需要进行raid-1，大小推荐不低于240GB

# 云管平台相关硬件

## 计算服务器

应当注意到，运管平台需要部署非常多的管理应用，而且每个应用似乎都无法有效利用一整个服务器硬件。
云管平台主要包含租户的控制台和运维管理员的控制台以及类似prometheus、alert manager等管理侧应用。

**计划上**，云管平台以及相关组件由一套单独的k8s集群支撑。这套k8s集群和要实际管理的容器云集群不是一套，而是独立开的系统。
使用k8s管理云管平台以及相关组件具备以下明显优势

* 避免管理平面的硬件故障等造成的管理功能失效，其中最严重的就是prometheus等监控告警系统的失效。
* 当管理面任务加剧时，可以通过水平扩展管理面服务器的方式解决。扩容后，k8s集群会自动进行应用平衡。
* 单region进行AZ水平延伸时，管理面的水平延伸和容器云的水平延伸可用类似的方法解决
* 管理面应用可以基于不同的团队被分配给不同的namespace，从而被分配合理的配额。
* 上线和部署系统的配置文件、环境变量等可以通过ConfigMap和其它k8s资源管理，不需要额外编辑配置文件以及在迁移应用时还要拷贝配置文件

```plantuml
@startuml
!include  https://plantuml.s3.cn-north-1.jdcloud-oss.com/C4_Container.puml
Boundary(存储网, 存储网) {
    System(远程存储, 远程存储) #orange
}
Boundary(管理网, 管理网, AZ-1) {
    Boundary(管理面服务器1, 管理面服务器, k8s) {
        Container(管理网网卡1, 管理网网卡) #red
        Container(存储网网卡1, 存储网网卡) #orange
    }
    Boundary(管理面服务器2, 管理面服务器, k8s) {
        Container(管理网网卡2, 管理网网卡) #red
        Container(存储网网卡2, 存储网网卡) #orange
    }
    Boundary(管理面服务器3, 管理面服务器, k8s) {
        Container(管理网网卡3, 管理网网卡) #red
        Container(存储网网卡3, 存储网网卡) #orange
    }
    管理网网卡1<-[#red]u->管理网网卡2
    管理网网卡3<-[#red]u->管理网网卡2
    存储网网卡1 -[#orange]d-> 远程存储
    存储网网卡2 -[#orange]d-> 远程存储
    存储网网卡3 -[#orange]d-> 远程存储
}
@enduml
```

k8s集群的最小规模为3个物理节点，在这样的设计下，管理面服务器

* cpu:mem为1:2
* 操作系统盘240G以上，用于存储安装的各种组件和管理面镜像
* 网卡推荐为2块，一块用于管理网 + k8s集群本身的pod流量；另一块用于访问存储设备。
  当然网卡也能为1块，这样所有网络流量就混杂在一起，而且可能要求管理网的网关承担较多的流量(去往其它网络的流量)
* 需要2块存储硬盘进行raid-1，主要用途是:
    * 管理面etcd的服务器
    * 管理面es服务器(将es调度在这些服务器上，直接读写本地磁盘)
* git、jenkins、prometheus、grafana等单机部署的组件推荐通过存储类对接远程存储。
* 没有远程存储则不得不将这些组件通过node taint固定在某个节点上，读写底层存储磁盘，因此也需要管理面的物理机具有存储磁盘。

## 存储系统

管理网的远程存储系统**建议**不单独规划，而是和容器云的pod所需的存储空间一并考虑。但是注意不要和租户的存储空间混用，而是单独规划一个存储池。
这也是存储网网卡的存在意义。如果管理面没有计划访问远程存储，则不需要存储网网卡。

## 网络交换机

云管平台使用的网络交换机没有什么特别的要求，常规的千兆交换机即可。

# 容器云平台硬件

容器云平台推荐分离部署，意味着master和worker一定是分开的，且master的起步节点数是3。worker的起步节点数是2(1个worker没有意义)

## 计算服务器

在采购时推荐容器云平台的常规服务器均为同构，这样有利于服务器故障时的临时替换。
工作节点的主要cpu:mem比依然是1:2或1:4。计算密集型或内存密集型的需要特别规划节点的标签，将正确的负载调度到工作节点上以免浪费。

在磁盘规划上和云管平台无异，都需要数据盘做raid-1(主要存储docker镜像和租户docker输出的日志)，
属于容量型需求，不宜太小，否则容器运行的日志没有几天就打满了。

如果容器云对租户提供数据库、缓存、消息队列等中间件，则按照中间件的研发团队的要求进行规划。

## 存储系统

容器云的物理机需要本地数据盘，且容器云应当具有可对接的文件存储系统和对象存储系统，**不推荐**应用通过挂载持久卷的方式自己弄文件服务器。

## 网络交换机

原则上容器云的多网卡设计应当在容器流量和存储流量上使用万兆网卡，从而需要万兆交换机。不过在建设初期可以使用千兆网卡先观察可能的流量，随着业务的发展和流量的上升以及旧交换机的替换，准备升级为万兆设备。


