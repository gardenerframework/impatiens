# 宗旨

本文主要提供一种基于生产环境部署文档的实验环境说明和验证，请首先阅读[[k8s生产集群部署](..%2Fk8s%E7%94%9F%E4%BA%A7%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2)]
中的所有章节来然后再看实验

# 企业网

按照
[[网络规划](..%2Fk8s%E7%94%9F%E4%BA%A7%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2%2F1.%20%E7%BD%91%E7%BB%9C%E8%A7%84%E5%88%92)]
文档的说明，
将企业网定为实验环境所在宿主机的网络192.168.0.0/24

```plantuml
@startuml
!include  https://plantuml.s3.cn-north-1.jdcloud-oss.com/C4_Container.puml

Boundary(192.168.0.0/24, 192.168.0.0/24) {
    System(192.168.0.105, 192.168.0.105, 开发主机)
    System(192.168.0.50, 192.168.0.50, 虚拟机基准镜像制备机)
}

@enduml
```

其中

* 192.168.0.105是一台开发主机主要进行云管平台的各种开发
* 192.168.0.50是一台制备实验环境的制备机，主要用于各种实验主机的制备

# 管理网

按照网关规划文档说明，管理网的云管理系统网段为100.64.0.0/20，k8s集群网的网段为100.64.64.0/20，企业内网应用映射区的网段为100.64.128.0/20

## 路由连通

现在创建一个路由器主机，在企业网、云管理系统网段、k8s集群管理网网段分别担任网关，并连通企业网。
联通企业网后不要设置到企业网的路由，等需要访问时再设置

```plantuml
@startuml
!include  https://plantuml.s3.cn-north-1.jdcloud-oss.com/C4_Container.puml

System(路由器, 路由器)
Boundary(192.168.0.0/24, 192.168.0.0/24, 企业网) {
    Container(192.168.0.51, 192.168.0.51)
}

Boundary(100.64.0.0/20, 100.64.0.0/20, 云管理系统网段) {
    Container(100.64.0.1, 100.64.0.1)
}

Boundary(100.64.64.0/20, 100.64.64.0/20, k8s集群管理网) {
    Container(100.64.64.1, 100.64.64.1)
}

Boundary(100.64.128.0/20, 100.64.128.0/20, 企业内网应用映射区) {
    Container(100.64.128.1, 100.64.128.1)
}

路由器 -u-> 192.168.0.51
路由器 -d-> 100.64.0.1
路由器 -d-> 100.64.64.1
路由器 -r-> 100.64.128.1
@enduml
```

## 在云管网映射跳板机

```plantuml
@startuml
!include  https://plantuml.s3.cn-north-1.jdcloud-oss.com/C4_Container.puml

System(路由器, 路由器)
System(跳板机, 跳板机)
Boundary(192.168.0.0/24, 192.168.0.0/24, 企业网) {
    Container(192.168.0.51, 192.168.0.51)
    Container(192.168.0.52, 192.168.0.52)
}

Boundary(100.64.0.0/20, 100.64.0.0/20, 云管理系统网段) {
    Container(100.64.0.1, 100.64.0.1)
    Container(100.64.0.52, 100.64.0.52)
}

Boundary(100.64.64.0/20, 100.64.64.0/20, k8s集群管理网) {
    Container(100.64.64.1, 100.64.64.1)
}

Boundary(100.64.128.0/20, 100.64.128.0/20, 企业内网应用映射区) {
    Container(100.64.128.1, 100.64.128.1)
    
}

路由器 -u-> 192.168.0.51
路由器 -d-> 100.64.0.1
路由器 -d-> 100.64.64.1
路由器 -d-> 100.64.128.1
跳板机 -u-> 192.168.0.52
跳板机 -d-> 100.64.0.52

@enduml
```

完成在企业网开放一个ip(192.168.0.52)充当管理网跳板机的作用，该跳板机在管理网的ip是100.64.0.52。
这台跳板机也当做部署机来使用

## 在云管网映射内部7层应用负载均衡器

```plantuml
@startuml
!include  https://plantuml.s3.cn-north-1.jdcloud-oss.com/C4_Container.puml

System(路由器, 路由器)
System(跳板机, 跳板机)
System(负载均衡, 负载均衡)
Boundary(192.168.0.0/24, 192.168.0.0/24, 企业网) {
    Container(192.168.0.51, 192.168.0.51)
    Container(192.168.0.52, 192.168.0.52)
    Container(192.168.0.53, 192.168.0.53)
}

Boundary(100.64.0.0/20, 100.64.0.0/20, 云管理系统网段) {
    Container(100.64.0.1, 100.64.0.1)
    Container(100.64.0.52, 100.64.0.52, 跳板机)
    Container(100.64.0.53, 100.64.0.53)
}

Boundary(100.64.64.0/20, 100.64.64.0/20, k8s集群管理网) {
    Container(100.64.64.1, 100.64.64.1)
}

Boundary(100.64.128.0/20, 100.64.128.0/20, 企业内网应用映射区) {
    Container(100.64.128.1, 100.64.128.1)
    
}

路由器 -u-> 192.168.0.51
路由器 -d-> 100.64.0.1
路由器 -d-> 100.64.64.1
路由器 -d-> 100.64.128.1
跳板机 -u-> 192.168.0.52
跳板机 -d-> 100.64.0.52
负载均衡 -u-> 192.168.0.53
负载均衡 -d-> 100.64.0.53

@enduml
```

在云管管和企业网内申请一个ip，部署一个nginx 7层代理。
该代理主要解决企业通过http访问管理网内部系统的问题(比如api server，比如监控系统)。
同时，这台机器需要设置到k8s集群管理网络的路由(vim /etc/sysconfig/network-scripts/route-网卡名称)

```text
100.64.64.0/20 via 100.64.0.1
```

这样将负载均衡到k8s管理网的路由设置到了云管网的网关
