# ip地址动态获取

主机的ip地址有2种途径设置，一种通过配置文件将ip地址静态的绑定在网卡上，另一种就是通过dhcp服务器进行动态管理。

通过在网卡配置文件上执行静态配置的ip实际很难得到应用，理由是

* 员工入职时需要找到IT人员申请ip，离职时需要归还ip，工作量繁重，管理难度大；
* 需要一张清晰地明细表来维护ip地址的使用和发放，否则可能出现1个ip地址分配给多人的情况，
  但本身这张表的维护就具有较大成本且效率低下
* 场景受限，例如咖啡厅、机场等人员流动本来就大的场所，无法执行静态的ip地址发放。

为了解决ip地址分配和管理的问题，需要使用dhcp服务

# dhcp

动态主机配置协议(**D**ynamic **H**ost **C**onfiguration **P**rotocol)是一个应用层协议，它用来管理ip地址池，并向申请方发送ip地址。

![dhcp请求.png](dhcp请求.png)

上图是一个捕捉到dhcp请求数据，逐层分析一下它的几个核心要点

* 它是一个应用层协议，其传输层使用UDP作为载体
* 源ip地址为0.0.0.0(因为请求主机此刻根本不知道自己的ip是什么)；目标地址为255.255.255.255， 即全网广播(
  它也不知道dhcp服务器的ip)
* 二层的目标地址为全网广播

dhcp服务器收到这个请求后回复响应，告知请求的主机被分配的ip是什么

![dhcp-offer.png](dhcp-offer.png)

可见回复的时候已经在目标地址上标记了请求方的ip，在响应中实际也会再次告诉请求方的ip是什么，并额外还会附带dns服务器等信息

# 租期 & 地址池

dhcp分配给主机的ip地址一般存在租期，这保证了相同ip地址在一定时间内不会被dhcp服务器再次分配给其它主机。
租期到达前，主机需要对使用的ip地址进行续租，否则这个ip dhcp就有可能分给别人。

这种设计有利于咖啡厅等人员流动较为频繁的场景。如果没有租期，dhcp服务器无法有效回收ip，过一会ip地址池就耗尽了。
dhcp能够分配的ip是由管理员人工输入的，他们通常会从企业的可用ip地址段中切出来一个网段给dhcp，否则还要记得哪个网段的哪些ip分配给dhcp，很麻烦

![dhcp-ip地址池.png](dhcp-ip地址池.png)

# 静态地址分配

如果dhcp服务器给云或者企业内部的员工使用时，通常会选择将ip与mac地址绑定从而实现较为静态的ip地址分配。
这样使得主机在下次申请ip时依然可以得到上一次使用的ip。
比如华为的论坛上就有如何对ip地址进行静态绑定的指令介绍: [[https://forum.huawei.com/enterprise/zh/thread/580940249801048064](https://forum.huawei.com/enterprise/zh/thread/580940249801048064)]

如果在云上要实现云主机的dhcp时，最好的做法就是将云主机的网卡mac和ip地址绑定，这样使得云主机每次启动时的ip地址也是固定的。

# 总结

ip地址可以由dhcp动态分配；其机制是在三层和二层都进行全网广播，既然是全网广播，那么二层广播域内的所有主机都能收到广播；收到广播后，非dhcp服务器会因为应用层没有查程序处理对应的数据包都丢弃，dhcp服务器会给请求者分配ip；
分配的ip有租期，租期到后要向dhcp服务器续租，否则这个ip就会被dhcp分配给别人；ip地址也可以和mac地址进行绑定，绑定后相当于主机启动后就会固定分配这个ip地址。

# 下一步阅读

[nat网络地址转换介绍](..%2Fnat%E7%BD%91%E7%BB%9C%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2%E4%BB%8B%E7%BB%8D)