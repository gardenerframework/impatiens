# vtep

云主机的二层报文从网卡上发出来需要进行封装，到了目标地址需要进行解封。这个封装和解封是谁负责呢？是vxlan的vtep负责

```plantuml
@startuml
!include  https://plantuml.s3.cn-north-1.jdcloud-oss.com/C4_Container.puml

Container(vm1, 10.0.0.2)
Container(vtep1, 192.168.1.5, vtep)
vm1 -d-> vtep1
Container(vm2, 10.0.0.3)
Container(vtep2, 192.168.1.6, vtep)
vm2 <-d- vtep2

vtep1 <-r-> vtep2
@enduml
```

10.0.0.2的包要发给10.0.0.3，是由192.168.1.5上的vtep程序封装为vxlan的包，然后将包发给192.168.1.6的vtep程序，由它解封后转给10.0.0.3

# vtep怎么彼此知道对方存在？

## vtep之间自己通过组播协议发现彼此

和二层一样，三层也有单播和广播协议的存在。

* 单播就是1对1通信，个人计算机访问百度、阿里、腾讯、京东，都是知道了对方的ip地址后直接发包过去通信，形成和对方服务器的1对1通信。
* 广播就是对子网内的所有机器通信，ip地址分为网络号 + 主机号，如果目标地址的主机号的每一个bit都是1，那就是对这个子网进行广播。
  比如对192.168.0.0/24进行广播，目标ip就要是192.168.0.255，目标mac = ff:ff:ff:ff:ff:ff

![家用路由器广播.png](家用路由器广播.png)

上图就是我家的路由器在广播，虽然不知道它在广播什么鬼东西

在单播和广播之上，ip网络还有组播。这是因为广播首先很浪费带宽，有些机器并不想收到广播，但还是被迫收到了；其次有些机器并不在广播的子网里，如果他也想收到包咋弄，一个广播只在子网内有用。组播的意思是在ip网内选定一组机器，给这一组进行进行通信。

ipv4有专门的用于组播的ip地址段，IANA规定，IPv4组播MAC地址的高24位为0x01005E，第25位为0，低23位为IPv4组播地址的低23位。

* 224.0.0.0～224.0.0.255为预留的组播地址（永久组地址），地址224.0.0.0保留不做分配，其它地址供路由协议使用
* 224.0.1.0～224.0.1.255是公用组播地址，可以用于Internet；
* 224.0.2.0～238.255.255.255为用户可用的组播地址（临时组地址），全网范围内有效；
* 239.0.0.0～239.255.255.255为本地管理组播地址，仅在特定的本地范围内有效

看完上面你可以发现，ipv4的32位中，前8位已经定了(224-239)，后面还有24位。
mac一共6字节，前3个字节iana定了，后面3个字节它定了1位，然后让你把组播地址的剩下3个字节填进去，所以你可以理解为一个组播ip就是一个组的标号

**警告**: 由于不是ip的后三个字节完整的写到组播mac中了，而是有一个字节只写了23位，因此会出现多个组播ip对应到同一个mac的时候，请不要把mac地址的后3个字节拿出来就直接当做组播编号使用

组播可以被路由器中转，也就是从一个子网转到另一个子网，子网广播不会。同时组播其实会被二层设备在隔离域内广播，部分交换机支持在接口上配置转发的组播mac地址，也就是转发的组编号。

于是，vtep就使用组播ip，将vni与组进行对应(可能多个vni对应一个组)，然后执行IGMP组播，宣称自己加入组并询问组内还有谁，从而获得负责相同vni的vtep清单。

## vtep之间通过进行发现

现在不妨回到一个vtep的视角，他其实已经知道了自己负责那些云主机，这些云主机的vni是什么以及mac都是什么，那么他能不能将这些信息和周边的vtep进行交换和传播，然后直接从其它vtep上获得他的学习成果？
答案当然是可以，可以借鉴bgp的工作方式。